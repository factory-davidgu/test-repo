name: Test FACTORY_API_KEY Configuration

# This workflow helps verify that FACTORY_API_KEY is properly configured
# Run manually from the Actions tab to test your secret configuration

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  verify-secret:
    runs-on: ubuntu-latest
    environment: droid  # Uses the same environment as the main workflow
    
    steps:
      - name: Check if FACTORY_API_KEY is configured
        env:
          FACTORY_API_KEY: ${{ secrets.FACTORY_API_KEY }}
        run: |
          if [ -n "$FACTORY_API_KEY" ]; then
            echo "✅ FACTORY_API_KEY is configured"
            echo "   Length: ${#FACTORY_API_KEY} characters"
            echo "   First 4 chars: ${FACTORY_API_KEY:0:4}..."
          else
            echo "❌ FACTORY_API_KEY is NOT configured"
            echo ""
            echo "To fix this:"
            echo "1. Go to: Settings > Secrets and variables > Actions"
            echo "2. Add a new secret named 'FACTORY_API_KEY'"
            echo "3. Get your API key from: https://app.factory.ai"
            exit 1
          fi
      
      - name: Install Droid CLI
        if: success()
        run: |
          echo "Installing Droid CLI..."
          curl -fsSL https://app.factory.ai/cli | sh
          echo "/usr/local/bin" >> $GITHUB_PATH
      
      - name: Verify Droid CLI installation
        if: success()
        run: |
          droid --version
          echo "✅ Droid CLI installed successfully"
      
      - name: Test Droid CLI with API key
        if: success()
        env:
          FACTORY_API_KEY: ${{ secrets.FACTORY_API_KEY }}
        run: |
          echo "Testing Droid CLI authentication..."
          # Simple test command - just verify it doesn't fail with auth error
          droid exec "What is 2+2?" --output-format json > /tmp/test-output.json || {
            echo "❌ Droid exec failed - check API key validity"
            exit 1
          }
          echo "✅ Droid CLI authentication successful"
          
      - name: Configuration summary
        if: always()
        run: |
          echo ""
          echo "================================================"
          echo "Configuration Test Summary"
          echo "================================================"
          echo ""
          if [ -n "${{ secrets.FACTORY_API_KEY }}" ]; then
            echo "✅ Secret is configured in repository"
          else
            echo "❌ Secret is missing - see setup instructions"
          fi
          echo ""
          echo "For more information, see:"
          echo "  - README.md (Setup Instructions)"
          echo "  - .github/SECRET_MANAGEMENT.md (Detailed Guide)"
          echo ""
